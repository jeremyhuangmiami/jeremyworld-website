<script>
  const gameGrid = document.getElementById("gameGrid");
  const gameModal = document.getElementById("gameModal");
  const modalGameTitle = document.getElementById("modalGameTitle");
  const iframe = document.getElementById("gameIframe");
  const closeModalBtn = document.getElementById("closeModalBtn");

  // 🔐 Login check before loading games
  async function checkLogin() {
    try {
      const res = await fetch("https://auth.jeremyworld.org/authcheck", {
        method: "GET",
        credentials: "include"
      });

      if (!res.ok) {
        window.location.href = "https://jeremyworld.org/notloggedin.html";
        return false;
      }

      const data = await res.json();
      if (!data.loggedIn) {
        window.location.href = "https://jeremyworld.org/notloggedin.html";
        return false;
      }

      return true;
    } catch (err) {
      console.error("Login check failed:", err);
      window.location.href = "https://jeremyworld.org/notloggedin.html";
      return false;
    }
  }

  // 🎮 Load games after login check
  async function loadGames() {
    try {
      const corsProxy = 'https://corsproxy.io/?';
      const jsonURL = 'https://www.onlinegames.io/media/plugins/genGames/embed.json';
      const response = await fetch(corsProxy + encodeURIComponent(jsonURL));
      if (!response.ok) throw new Error(`HTTP error ${response.status}`);
      const games = await response.json();

      games.forEach(game => {
        const tile = document.createElement("div");
        tile.className = "cursor-pointer transform hover:scale-105 transition-transform duration-300 bg-gray-700 bg-opacity-60 p-3 rounded-xl shadow-md border border-gray-600 hover:border-teal-400 project-card-hover glow-shadow-card";
        tile.innerHTML = `
          <img src="${game.image}" alt="${game.title}" class="w-full h-28 object-cover rounded-md mb-2">
          <h4 class="text-center text-white font-semibold text-sm truncate">${game.title}</h4>
        `;
        tile.addEventListener("click", () => {
          gameModal.classList.remove("hidden");
          iframe.src = game.embed;
          modalGameTitle.textContent = game.title;
        });
        gameGrid.appendChild(tile);
      });
    } catch (err) {
      console.error("Error loading games:", err);
      gameGrid.innerHTML = `<p class="text-center text-red-400">Failed to load games. Try again later.</p>`;
    }
  }

  // 🧼 Modal cleanup
  closeModalBtn?.addEventListener("click", () => {
    gameModal.classList.add("hidden");
    iframe.src = "";
  });

  window.addEventListener("click", e => {
    if (e.target === gameModal) {
      gameModal.classList.add("hidden");
      iframe.src = "";
    }
  });

  window.addEventListener("keydown", e => {
    if (e.key === "Escape" && !gameModal.classList.contains("hidden")) {
      gameModal.classList.add("hidden");
      iframe.src = "";
    }
  });

  // 🚀 Start the page
  checkLogin().then(ok => {
    if (ok) loadGames();
  });
</script>
